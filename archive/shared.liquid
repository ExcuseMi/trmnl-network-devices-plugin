<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">

<style>
  .material-symbols-outlined {
    font-variation-settings: 'FILL' 0, 'wght' 600, 'GRAD' 0, 'opsz' 26;
  }
  .offline-device {
    opacity: 0.6;
    }
  
    .small-icon {
      font-size: 14px;
      vertical-align: middle;
    }
    .trmnl .border--h-1.top::before {
      top:0;
      bottom:auto;
    }
    .nobg {
      background: none;
    }
</style>

{% template devices %}
{% liquid
assign owner_user_id = 6458
if trmnl.user.id == owner_user_id
  assign devices_list = "192.168.1.1|router.local|AA:BB:CC:DD:EE:01|TP-Link|Router|0|80,443,9000~~~192.168.1.3|living-room-light|AA:BB:CC:DD:EE:02|Philips|Smart Device|0|~~~192.168.1.10|home-server|AA:BB:CC:DD:EE:03||Raspberry Pi|0|22,80,443~~~192.168.1.16|guest-laptop|AA:BB:CC:DD:EE:04|||0|~~~192.168.1.17|work-laptop|AA:BB:CC:DD:EE:05|||0|22~~~192.168.1.18|kitchen-speaker|AA:BB:CC:DD:EE:06|Sonos|Speaker|0|~~~192.168.1.21|bedroom-plug|AA:BB:CC:DD:EE:07|Tuya|Smart Device|0|~~~192.168.1.22|office-speaker|AA:BB:CC:DD:EE:08||Speaker|0|~~~192.168.1.24|tv-streamer|AA:BB:CC:DD:EE:09||TV/Streaming|0|~~~192.168.1.41|office-printer|AA:BB:CC:DD:EE:10|Brother|Printer|0|631~~~192.168.1.45|iot-hub|AA:BB:CC:DD:EE:11|||0|~~~192.168.1.62|garage-camera|AA:BB:CC:DD:EE:12||Camera|0|~~~192.168.1.23|johns-iphone|AA:BB:CC:DD:EE:13||Mobile Device|0|~~~192.168.1.34|sams-tablet|AA:BB:CC:DD:EE:14||Mobile Device|-800|~~~192.168.1.52|nas-server|AA:BB:CC:DD:EE:15||NAS|-800|22,80,443~~~192.168.1.64|mesh-node|AA:BB:CC:DD:EE:16||Router|-800|~~~192.168.1.27|field-tablet|AA:BB:CC:DD:EE:17||Mobile Device|-800|~~~192.168.1.26|esp-sensor-01|AA:BB:CC:DD:EE:18||IoT Sensor|-10000|" | split: "~~~"
  assign v = "v1.1|v1.1|" | append: trmnl.system.timestamp_utc
endif

assign default_mappings = "memory=raspberry;pi|phone_iphone=apple;iphone|tablet_mac=ipad|laptop_mac=macbook;imac|headphones=airpod|nest_remote=google;nest|cast=chromecast|smartphone=samsung;galaxy;phone;mobile;android|speaker=sonos;audio;speaker|router=tp-link;tplink;netgear;linksys;asus;d-link;gateway;modem;ubiquiti;unifi|print=brother;hp;epson;canon;printer|lightbulb=hue;light;bulb|smart_toy=amazon;echo;alexa|sports_esports=microsoft;xbox|videogame_asset=sony;playstation;ps4;ps5;nintendo;switch|tv=nvidia;shield;roku|power=tuya;smart;plug|settings_input_hdmi=switch|storage=nas|videocam=camera;cam|thermostat=thermostat|doorbell=doorbell|tablet=tablet|laptop=laptop|computer=desktop;pc|watch=watch|host=server"
assign default_map_array = default_mappings | split: "|"

assign default_port_labels = "20=FTP Data,21=FTP,22=SSH,23=Telnet,25=SMTP,53=DNS,67=DHCP,68=DHCP,80=HTTP,110=POP3,123=NTP,143=IMAP,161=SNMP,179=BGP,194=IRC,389=LDAP,443=HTTPS,445=SMB,465=SMTPS,514=Syslog,515=LPR,587=SMTP,631=IPP,636=LDAPS,993=IMAPS,995=POP3S,1080=SOCKS,1194=OpenVPN,1433=MSSQL,1521=Oracle,1723=PPTP,1883=MQTT,3000=Dev Server,3306=MySQL,3389=RDP,5000=UPnP,5432=PostgreSQL,5900=VNC,5984=CouchDB,6379=Redis,8000=HTTP Alt,8008=HTTP Alt,8080=HTTP Proxy,8123=Home Assistant,8443=HTTPS Alt,8883=MQTTS,9000=Management,9090=Prometheus,27017=MongoDB,32400=Plex"

assign device_identifiers = trmnl.plugin_settings.custom_fields_values.device_identifiers
assign show_mac_addresses = trmnl.plugin_settings.custom_fields_values.show_mac_addresses | downcase
assign show_offline_devices = trmnl.plugin_settings.custom_fields_values.show_offline_devices | default: "yes"
assign show_ports = trmnl.plugin_settings.custom_fields_values.show_ports | default: "no"
assign port_display_mode = trmnl.plugin_settings.custom_fields_values.port_display_mode | default: "both"
assign port_labels = trmnl.plugin_settings.custom_fields_values.port_labels
assign show_update_notification = trmnl.plugin_settings.custom_fields_values.show_update_notification | default: "yes"

assign v_string = v | default: ""
assign v_parts = v_string | split: "|"
assign current_version = v_parts[0] | default: ""
assign latest_version = v_parts[1] | default: ""
assign scan_timestamp = v_parts[2] | default: "" | plus: 0

if scan_timestamp == 0
  assign scan_timestamp = trmnl.system.timestamp_utc | minus: 600
endif

assign has_update = false
if current_version != "" and latest_version != "" and current_version != latest_version and show_update_notification == "yes"
  assign has_update = true
endif

%}
{% assign offline_gray = "" %}

<div class="layout layout--stretch layout--center">
  {% comment %} Parse all devices into JSON objects first {% endcomment %}
  {% assign current_time = trmnl.system.timestamp_utc %}
  {% assign all_devices_json = "[" %}
  
  {% for device_line in devices_list %}
  {% unless device_line == "" %}
  {% assign parts = device_line | split: "|" %}
  {% assign device_ip = parts[0] %}
  {% assign device_hostname = parts[1] %}
  {% assign device_mac = parts[2] %}
  {% assign device_vendor = parts[3] %}
  {% assign device_type = parts[4] %}
  {% assign last_seen_ts = parts[5] | default: "" %}
  {% assign device_ports = parts[6] | default: "" %}
  
  {% comment %} Calculate offline status {% endcomment %}
  {% assign last_seen_num = last_seen_ts | plus: 0 %}
  {% if last_seen_num <= 0 %}
    {% assign last_seen_num = current_time | plus: last_seen_num %}
  {% endif %}
  
  {% comment %} Device is offline if last_seen is before scan_timestamp {% endcomment %}
  {% assign is_offline = false %}
  {% if last_seen_num < scan_timestamp %}
    {% assign is_offline = true %}
  {% endif %}
  {% assign time_diff = current_time | minus: last_seen_num %}
  
  {% comment %} Create sortable IP {% endcomment %}
  {% assign ip_parts = device_ip | split: "." %}
  {% assign octet1 = ip_parts[0] | plus: 0 %}
  {% assign octet2 = ip_parts[1] | plus: 0 %}
  {% assign octet3 = ip_parts[2] | plus: 0 %}
  {% assign octet4 = ip_parts[3] | plus: 0 %}
  
  {% if octet1 < 10 %}{% assign octet1_str = "00" | append: octet1 %}{% elsif octet1 < 100 %}{% assign octet1_str = "0" | append: octet1 %}{% else %}{% assign octet1_str = octet1 | append: "" %}{% endif %}
  {% if octet2 < 10 %}{% assign octet2_str = "00" | append: octet2 %}{% elsif octet2 < 100 %}{% assign octet2_str = "0" | append: octet2 %}{% else %}{% assign octet2_str = octet2 | append: "" %}{% endif %}
  {% if octet3 < 10 %}{% assign octet3_str = "00" | append: octet3 %}{% elsif octet3 < 100 %}{% assign octet3_str = "0" | append: octet3 %}{% else %}{% assign octet3_str = octet3 | append: "" %}{% endif %}
  {% if octet4 < 10 %}{% assign octet4_str = "00" | append: octet4 %}{% elsif octet4 < 100 %}{% assign octet4_str = "0" | append: octet4 %}{% else %}{% assign octet4_str = octet4 | append: "" %}{% endif %}
  
  {% assign sortable_ip = octet1_str | append: "." | append: octet2_str | append: "." | append: octet3_str | append: "." | append: octet4_str %}
  
  {% comment %} Build JSON object {% endcomment %}
  {% if forloop.index0 > 0 %}{% assign all_devices_json = all_devices_json | append: "," %}{% endif %}
  {% capture device_json %}{"ip":"{{ device_ip }}","hostname":"{{ device_hostname }}","mac":"{{ device_mac }}","vendor":"{{ device_vendor }}","type":"{{ device_type }}","ports":"{{ device_ports }}","is_offline":{{ is_offline }},"time_diff":{{ time_diff }},"sortable_ip":"{{ sortable_ip }}"}{% endcapture %}
  {% assign all_devices_json = all_devices_json | append: device_json %}
  {% endunless %}
  {% endfor %}
  
  {% assign all_devices_json = all_devices_json | append: "]" %}
  {% assign all_devices = all_devices_json | parse_json %}
  
  {% comment %} Separate into online and offline arrays {% endcomment %}
  {% assign online_with_sort = "" %}
  {% assign offline_with_sort = "" %}
  
  {% for device in all_devices %}
  {% if device.is_offline %}
    {% if show_offline_devices == "yes" %}
      {% comment %} For offline: pad time_diff to 10 digits for sorting (most recent = smallest time_diff first) {% endcomment %}
      {% assign time_diff_num = device.time_diff | plus: 0 %}
      {% assign sortable_time = "" %}
      {% if time_diff_num < 10 %}{% assign sortable_time = "000000000" | append: time_diff_num %}
      {% elsif time_diff_num < 100 %}{% assign sortable_time = "00000000" | append: time_diff_num %}
      {% elsif time_diff_num < 1000 %}{% assign sortable_time = "0000000" | append: time_diff_num %}
      {% elsif time_diff_num < 10000 %}{% assign sortable_time = "000000" | append: time_diff_num %}
      {% elsif time_diff_num < 100000 %}{% assign sortable_time = "00000" | append: time_diff_num %}
      {% elsif time_diff_num < 1000000 %}{% assign sortable_time = "0000" | append: time_diff_num %}
      {% elsif time_diff_num < 10000000 %}{% assign sortable_time = "000" | append: time_diff_num %}
      {% elsif time_diff_num < 100000000 %}{% assign sortable_time = "00" | append: time_diff_num %}
      {% elsif time_diff_num < 1000000000 %}{% assign sortable_time = "0" | append: time_diff_num %}
      {% else %}{% assign sortable_time = time_diff_num | append: "" %}
      {% endif %}
      
      {% assign sortable_entry = sortable_time | append: "|||" | append: forloop.index0 %}
      {% if offline_with_sort != "" %}{% assign offline_with_sort = offline_with_sort | append: "~~~" %}{% endif %}
      {% assign offline_with_sort = offline_with_sort | append: sortable_entry %}
    {% endif %}
  {% else %}
    {% comment %} For online: sort by IP {% endcomment %}
    {% assign sortable_entry = device.sortable_ip | append: "|||" | append: forloop.index0 %}
    {% if online_with_sort != "" %}{% assign online_with_sort = online_with_sort | append: "~~~" %}{% endif %}
    {% assign online_with_sort = online_with_sort | append: sortable_entry %}
  {% endif %}
  {% endfor %}
  
  {% comment %} Sort and extract indices {% endcomment %}
  {% assign online_sorted_entries = online_with_sort | split: "~~~" | sort %}
  {% assign offline_sorted_entries = offline_with_sort | split: "~~~" | sort %}
  
  {% comment %} Rebuild sorted JSON array {% endcomment %}
  {% assign sorted_json = "[" %}
  {% assign device_count = 0 %}
  
  {% for entry in online_sorted_entries %}
  {% unless entry == "" %}
    {% assign entry_parts = entry | split: "|||" %}
    {% assign device_index = entry_parts[1] | plus: 0 %}
    {% assign device = all_devices[device_index] %}
    
    {% if device_count > 0 %}{% assign sorted_json = sorted_json | append: "," %}{% endif %}
    {% capture device_json %}{"ip":"{{ device.ip }}","hostname":"{{ device.hostname }}","mac":"{{ device.mac }}","vendor":"{{ device.vendor }}","type":"{{ device.type }}","ports":"{{ device.ports }}","is_offline":{{ device.is_offline }},"time_diff":{{ device.time_diff }}}{% endcapture %}
    {% assign sorted_json = sorted_json | append: device_json %}
    {% assign device_count = device_count | plus: 1 %}
  {% endunless %}
  {% endfor %}
  
  {% for entry in offline_sorted_entries %}
  {% unless entry == "" %}
    {% assign entry_parts = entry | split: "|||" %}
    {% assign device_index = entry_parts[1] | plus: 0 %}
    {% assign device = all_devices[device_index] %}
    
    {% if device_count > 0 %}{% assign sorted_json = sorted_json | append: "," %}{% endif %}
    {% capture device_json %}{"ip":"{{ device.ip }}","hostname":"{{ device.hostname }}","mac":"{{ device.mac }}","vendor":"{{ device.vendor }}","type":"{{ device.type }}","ports":"{{ device.ports }}","is_offline":{{ device.is_offline }},"time_diff":{{ device.time_diff }}}{% endcapture %}
    {% assign sorted_json = sorted_json | append: device_json %}
    {% assign device_count = device_count | plus: 1 %}
  {% endunless %}
  {% endfor %}
  
  {% assign sorted_json = sorted_json | append: "]" %}
  {% assign sorted_devices = sorted_json | parse_json %}
  
  {% comment %} Count non-empty entries {% endcomment %}
  {% assign online_devices_count = 0 %}
  {% for entry in online_sorted_entries %}
    {% unless entry == "" %}
      {% assign online_devices_count = online_devices_count | plus: 1 %}
    {% endunless %}
  {% endfor %}
  
  {% assign offline_devices_count = 0 %}
  {% for entry in offline_sorted_entries %}
    {% unless entry == "" %}
      {% assign offline_devices_count = offline_devices_count | plus: 1 %}
    {% endunless %}
  {% endfor %}
     
  {% if sorted_devices.size > 0 %}
    <div class="columns" data-overflow-max-cols="{{max_columns}}" data-overflow-counter="true">
      <div class="column">

        {% comment %} Render sorted device objects {% endcomment %}
        {% for device in sorted_devices %}
        
        {% assign device_ip = device.ip %}
        {% assign device_hostname = device.hostname %}
        {% assign device_mac = device.mac %}
        {% assign device_vendor = device.vendor %}
        {% assign device_type = device.type %}
        {% assign device_ports = device.ports %}
        {% assign is_offline = device.is_offline %}
        {% assign time_diff = device.time_diff %}

          {% comment %} Check if device should be hidden and apply custom identifiers {% endcomment %}
          {% assign should_hide = false %}
          {% assign custom_icon = "" %}
          {% assign has_custom_override = false %}
          {% assign custom_port_labels = "" %}

          {% if device_identifiers %}
          {% assign identifier_list = device_identifiers | split: "," %}
          {% for identifier in identifier_list %}
          {% assign id_parts = identifier | split: ";" %}
          {% assign should_apply = false %}

          {% comment %} Check if this identifier matches current device {% endcomment %}
          {% for id_part in id_parts %}
          {% assign kv = id_part | split: "=" %}
          {% assign key = kv[0] | strip | upcase %}
          {% assign value = kv[1] | strip | upcase %}
          {% assign device_mac_upper = device_mac | upcase %}

          {% if key == "MAC" and device_mac_upper == value %}
          {% assign should_apply = true %}
          {% elsif key == "IP" and device_ip == value %}
          {% assign should_apply = true %}
          {% endif %}
          {% endfor %}

          {% comment %} If matched, apply all custom fields {% endcomment %}
          {% if should_apply %}
          {% assign has_custom_override = true %}
          {% for id_part in id_parts %}
          {% assign kv = id_part | split: "=" %}
          {% assign key = kv[0] | strip | downcase %}
          {% assign value = kv[1] | strip %}

          {% if key == "name" %}
          {% assign device_hostname = value %}
          {% elsif key == "vendor" %}
          {% assign device_vendor = value %}
          {% elsif key == "type" %}
          {% assign device_type = value %}
          {% elsif key == "icon" %}
          {% assign custom_icon = value %}
          {% elsif key == "ports" %}
          {% assign custom_port_labels = value %}
          {% elsif key == "hide" and value == "true" %}
          {% assign should_hide = true %}
          {% endif %}
          {% endfor %}
          {% endif %}
          {% endfor %}
          {% endif %}

          {% comment %} If hostname is same as IP, clear it to avoid redundancy {% endcomment %}
          {% if device_hostname == device_ip %}
          {% assign device_hostname = "" %}
          {% endif %}

          {% unless should_hide %}

          {% assign vendor_lower = device_vendor | downcase %}
          {% assign hostname_lower = device_hostname | downcase %}

          {% comment %} Build search string for matching {% endcomment %}
          {% assign search_str = vendor_lower | append: " " | append: hostname_lower %}

          {% comment %} Default icon {% endcomment %}
          {% assign matched_icon = "router" %}

          {% comment %} Use custom icon if specified {% endcomment %}
          {% if custom_icon != "" %}
          {% assign matched_icon = custom_icon %}
          {% else %}
          {% comment %} Otherwise check default mappings {% endcomment %}
          {% for mapping in default_map_array %}
          {% assign map_parts = mapping | split: "=" %}
          {% assign icon_name = map_parts[0] | strip %}
          {% assign keywords = map_parts[1] | split: ";" %}

          {% for keyword in keywords %}
          {% assign kw = keyword | strip | downcase %}
          {% if search_str contains kw %}
          {% assign matched_icon = icon_name %}
          {% break %}
          {% endif %}
          {% endfor %}

          {% if matched_icon != "router" %}
          {% break %}
          {% endif %}
          {% endfor %}
          {% endif %}
          {% if show_headers and show_offline_devices == 'no' %}
          {% assign show_headers = false %}
          {% endif %}
          {% if show_headers %}
          {% unless is_offline %}
          {% if forloop.index0 == 0 %}
          <span class="label label--medium group-header" data-group-header="true">ONLINE</span>
          {% endif %}
          {% endunless %}
          {% assign first_offline = false %}
          {% if is_offline and online_devices_count > 0 %}
          {% unless has_offlines %}
          <span class="label label--medium group-header" data-group-header="true">OFFLINE</span>
          {% endunless %}
          {% endif %}
          {% endif %}
          <div class="item item--emphasis-{% if is_offline %}1{% else %}{{ forloop.index0 | modulo: 3 | plus: 1}}{% endif %}">

            <div class="meta w--8 {% if is_offline %}nobg{% endif %}">
              {% if show_headers == false and is_offline %}
              <div class="image image-stroke material-symbols-outlined offline-device {{offline_gray}}">signal_disconnected</div>
              {% else %}
              <div class="image image-dither image-stroke material-symbols-outlined {% if is_offline %} offline-device {{offline_gray}}{% endif %}">{{ matched_icon }}</div>
              {% endif %}
            </div>

            <div class="content{% if is_offline %} {{offline_gray}}{% endif %}">
              {% assign show_unknown_device = true %}

              {% if device_hostname != "" %}
              {% assign show_unknown_device = false %}
              <span class="title title--small {% if is_offline %} offline-device {{offline_gray}}{% else %} text-stroke{% endif %}" data-field="device_hostname">{{ device_hostname }}</span>
              <span class="description {% if is_offline %} {{offline_gray}}{% endif %}" data-field="device_ip">{{ device_ip }}</span>
              {% else %}
              <span class="title title--small {% if is_offline %} offline-device {{offline_gray}}{% else %} text-stroke{% endif %}" data-field="device_ip">{{ device_ip }}</span>
              {% endif %}
              {% if device_type != "" %}
              {% if device_vendor != "" %}
              <div class="description {% if is_offline %} {{offline_gray}}{% endif %}" data-field="device_type_device_vendor">{{ device_type }} ({{ device_vendor }})</div>
              {% assign show_unknown_device = false %}
              {% else %}
              <div class="description {% if is_offline %} {{offline_gray}}{% endif %}" data-field="device_type">{{ device_type }}</div>
              {% assign show_unknown_device = false %}
              {% endif %}
              {% elsif device_vendor != "" and device_vendor != "Unknown" %}
              <div class="description {% if is_offline %} {{offline_gray}}{% endif %}" data-field="device_vendor">{{ device_vendor }}</div>
              {% assign show_unknown_device = false %}
              {% endif %}
              {% if show_mac_addresses == "yes" and device_mac != "" %}
              <div class="description {% if is_offline %} {{offline_gray}}{% endif %}" data-field="device_mac">{{ device_mac }}</div>
              {% assign show_unknown_device = false %}
              {% endif %}
              {% comment %} Show ports if enabled and available and device is online {% endcomment %}
              {% if show_ports == "yes" and device_ports != "" and is_offline == false %}
              <div class="description {% if is_offline %} {{offline_gray}}{% endif %}">
                {% assign port_list = device_ports | split: "," %}
                {% for port in port_list %}
                {% assign port_num = port | strip %}
                {% assign port_label = "" %}
                
                {% comment %} Check for per-device custom port labels first {% endcomment %}
                {% if custom_port_labels != "" %}
                {% assign device_label_list = custom_port_labels | split: ":" %}
                {% for device_label_pair in device_label_list %}
                {% assign device_label_parts = device_label_pair | split: "=" %}
                {% assign device_label_port = device_label_parts[0] | strip %}
                {% assign device_label_text = device_label_parts[1] | strip %}
                {% if device_label_port == port_num %}
                {% assign port_label = device_label_text %}
                {% break %}
                {% endif %}
                {% endfor %}
                {% endif %}
                
                {% comment %} If no per-device label, check global port labels {% endcomment %}
                {% if port_label == "" and port_labels != "" %}
                {% assign label_list = port_labels | split: "," %}
                {% for label_pair in label_list %}
                {% assign label_parts = label_pair | split: "=" %}
                {% assign label_port = label_parts[0] | strip %}
                {% assign label_text = label_parts[1] | strip %}
                {% if label_port == port_num %}
                {% assign port_label = label_text %}
                {% break %}
                {% endif %}
                {% endfor %}
                {% endif %}
                
                {% comment %} If still no label, check default port labels {% endcomment %}
                {% if port_label == "" %}
                {% assign default_label_list = default_port_labels | split: "," %}
                {% for default_label_pair in default_label_list %}
                {% assign default_label_parts = default_label_pair | split: "=" %}
                {% assign default_label_port = default_label_parts[0] | strip %}
                {% assign default_label_text = default_label_parts[1] | strip %}
                {% if default_label_port == port_num %}
                {% assign port_label = default_label_text %}
                {% break %}
                {% endif %}
                {% endfor %}
                {% endif %}
                
                {% comment %} Display based on mode {% endcomment %}
                {% assign label_style = "label label--small label--outline" %}
                {% if port_display_mode == "number" %}
                <span class="{{label_style}}">{{ port_num }}</span>
                {% elsif port_display_mode == "label" %}
                {% if port_label != "" %}
                <span class="{{label_style}}">{{ port_label }}</span>
                {% else %}
                <span class="{{label_style}}">{{ port_num }}</span>
                {% endif %}
                {% else %}
                {% comment %} both mode (default) {% endcomment %}
                {% if port_label != "" %}
                <span class="{{label_style}}">{{ port_num }} ({{ port_label }})</span>
                {% else %}
                <span class="{{label_style}}">{{ port_num }}</span>
                {% endif %}
                {% endif %}
                {% endfor %}
              </div>
              {% assign show_unknown_device = false %}
              {% endif %}
              {% comment %} Only show "Unknown Device" if no custom override and no info available {% endcomment %}
              {% if show_unknown_device and has_custom_override == false %}
              <div class="description {% if is_offline %} {{offline_gray}}{% endif %}" data-field="device_unknown">Unknown Device</div>
              {% endif %}
              {% if is_offline %}
              <div>
                <span class="material-symbols-outlined image image-stroke offline-device small-icon" style="font-size: 12px">history</span>
                <span class="description time-delta {{offline_gray}}" data-seconds="{{time_diff}}"></span>
              </div>
              {% endif %}
            </div>
          </div>

          {% endunless %}
          {% if is_offline %}
          {% assign has_offlines = true %}
          {% endif %}
          {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="flex flex--col center flex--center-y" data-overflow="true">
    <div class="title text--center">No devices were found.</div>
    {{ "https://github.com/ExcuseMi/trmnl-network-devices-plugin/" | qr_code: 4, 'l'}}
    </div>
    {% endif %}
</div>
<div class="title_bar">
  <img class="image image-stroke" src="https://github.com/ExcuseMi/trmnl-network-devices-plugin/blob/main/images/home_network.png?raw=true" />
  <span class="title">Network devices{% if current_version != "" %} {{ current_version }}{% else %} v1.0{% endif %}</span>
  {% if has_update %} <span class="image image-stroke material-symbols-outlined">system_update_alt</span>{% endif %}
  <span class="instance flex flex--row flex--right">
    {% if online_devices_count > 0 %}
    <span class="image image-stroke material-symbols-outlined">online_prediction</span>
    <span class="label">{{online_devices_count}}</span>
    {% endif %}
    {% if offline_devices_count > 0 %}
    <span class="image image-stroke material-symbols-outlined">signal_disconnected</span>
    <span class="label">{{offline_devices_count}}</span>
    {% endif %}
</div>
<script>
  (function() {
    function formatTimeDelta() {
      const locale = '{{ user_locale }}';

      document.querySelectorAll('.time-delta').forEach(el => {
        const seconds = parseInt(el.dataset.seconds);
        if (!seconds) return;

        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(seconds / 3600);
        const days = Math.floor(seconds / 86400);
        const months = Math.floor(days / 30);
        const years = Math.floor(days / 365);

        let formatted;
        let unit;

        if (years > 0) {
          formatted = years;
          unit = years === 1 ? 'year' : 'years';
        } else if (months > 0) {
          formatted = months;
          unit = months === 1 ? 'month' : 'months';
        } else if (days > 0) {
          formatted = days;
          unit = days === 1 ? 'day' : 'days';
        } else if (hours > 0) {
          formatted = hours;
          unit = hours === 1 ? 'hour' : 'hours';
        } else if (minutes > 0) {
          formatted = minutes;
          unit = minutes === 1 ? 'minute' : 'minutes';
        } else {
          formatted = '<1';
          unit = 'minute';
        }

        el.textContent = '' + formatted + ' ' + unit + ' ago';
      });
    }

    // Run immediately
    formatTimeDelta();
    // Also run when DOM is ready (in case script runs before elements exist)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', formatTimeDelta);
    }
  })();
</script>
<script />
{% endtemplate %}